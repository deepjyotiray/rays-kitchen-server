<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Receipt – Mr & Mrs Ray</title>

<style>
:root {
  --bg: #fafafa;
  --card: #fff;
  --text: #222;
  --muted: #444;
  --border: #000;
  --table-border: #000;
  --thead: #f0f0f0;
  --watermark: rgba(16, 185, 129, 0.22);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f172a;
    --card: #111827;
    --text: #e5e7eb;
    --muted: #cbd5e1;
    --border: #1f2937;
    --table-border: #334155;
    --thead: #1e293b;
    --watermark: rgba(16, 185, 129, 0.28);
  }
}

body {
  font-family: Arial, sans-serif;
  font-size: 12px;
  color: var(--text);
  padding: 24px;
  background: var(--bg);
  position: relative;
}

/* ===== PAID WATERMARK (TOP OVERLAY) ===== */
.watermark {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-35deg);
  font-size: 120px;
  font-weight: 900;
  color: var(--watermark);
  pointer-events: none;
  user-select: none;
  z-index: 9999;
}

/* ===== HEADER ===== */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid var(--border);
  padding-bottom: 10px;
  margin-bottom: 16px;
}

.header-left .title {
  font-size: 18px;
  font-weight: bold;
}

.header-left .subtitle {
  font-size: 11px;
}

.logo {
  height: 90px;
}

/* ===== INFO ===== */
.info {
  margin-bottom: 14px;
}

/* ===== TABLE ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  background: var(--card);
}

th, td {
  border: 1px solid var(--table-border);
  padding: 8px;
}

th {
  background: var(--thead);
}

.num {
  text-align: right;
}

.total-row td {
  font-weight: bold;
  font-size: 13px;
}

/* ===== FOOTER ===== */
.footer {
  margin-top: 20px;
  font-size: 11px;
  color: var(--muted);
}

#error {
  color: red;
  text-align: center;
}
</style>
</head>

<body>

<!-- PAID WATERMARK -->
<div class="watermark">PAID</div>

<div id="receipt" style="display:none">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="title">PAYMENT RECEIPT</div>
      <div class="subtitle">
        Mr & Mrs Ray’s Home Kitchen<br>
        Home-style meals • Freshly prepared<br>
        Phone: 8850545924<br>
        Email: <a href="mailto:kitchen@healthymealspot.com" style="color:inherit;text-decoration:none;">kitchen@healthymealspot.com</a>
      </div>
    </div>

    <img src="../images/logo1.jpg" class="logo">
  </div>

  <!-- INFO -->
  <div class="info">
    <strong>Receipt No:</strong> <span id="orderId"></span><br>
    <strong>Date:</strong> <span id="date"></span><br><br>

    <strong>Customer:</strong> <span id="customer"></span><br>
    <strong>Phone:</strong> <span id="phone"></span><br>
    <strong>Address:</strong> <span id="address"></span>
  </div>

  <!-- ITEMS -->
  <table id="itemsTable">
    <tr>
      <th>Description</th>
      <th class="num">Amount</th>
    </tr>
  </table>

  <div class="footer">
    Thank you for your payment.<br>
    This is a computer-generated receipt.
  </div>

</div>

<div id="error"></div>

<script>
const isLocalHost =
  location.hostname === "localhost" || location.hostname === "127.0.0.1";
const API_BASE = isLocalHost
  ? "http://localhost:3000"
  : "https://api.healthymealspot.com";

const orderId = new URLSearchParams(location.search).get("orderId");
if (!orderId) fail("Invalid receipt link");

fetch(`${API_BASE}/receipt?orderId=${orderId}`)
  .then(r => r.json())
  .then(d => {
    if (!d.success) throw "";
    render(d.receipt);
  })
  .catch(() => fail("Unable to load receipt"));

function render(o) {
  if (!o || typeof o !== "object") return fail("Invalid receipt data");

  document.getElementById("orderId").innerText = o.orderId;
  document.getElementById("date").innerText = o.date;
  document.getElementById("customer").innerText = o.customer;
  document.getElementById("phone").innerText = o.phone;
  document.getElementById("address").innerText = o.address;

  const table = document.getElementById("itemsTable");

  const lines = normalizeLines(o.items);
  let itemsTotal = 0;
  let extrasTotal = 0;

  if (!lines.length) {
    table.insertAdjacentHTML("beforeend", `
      <tr>
        <td colspan="2">No items available</td>
      </tr>
    `);
  }

  lines.forEach(line => {
    if (!line.trim()) return;

    const amt = parseAmount(line);

    const itemPart = line.split("=")[0].trim();
    const baseName = (itemPart.split(/x\s*\d+/i)[0] || "").trim() || "Item";

    const extrasMatch = itemPart.match(/\((.*?)\)/);
    const itemExtras = extrasMatch ? extrasMatch[1].trim() : "";

    table.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          ${baseName}
          ${
            itemExtras
              ? `<div style="font-size:11px;color:#444;margin-top:4px;">
                  Extras: ${itemExtras}
                </div>`
              : ""
          }
        </td>
        <td class="num">${formatSignedCurrency(amt)}</td>
      </tr>
    `);
    itemsTotal += Number(amt) || 0;

  });

  if (Array.isArray(o.extras)) {
    o.extras.forEach(ex => {
      const amt = Number(ex.amount) || 0;
      extrasTotal += amt;
      table.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${ex.label}</td>
          <td class="num">${formatSignedCurrency(amt, ex.label)}</td>
        </tr>
      `);
    });
  }

  // If the backend total includes charges not captured in items/extras (e.g., "as per actuals")
  const gap = Number(o.total) - (itemsTotal + extrasTotal);
  if (gap > 0.49) {
    table.insertAdjacentHTML("beforeend", `
      <tr>
        <td>Delivery (actuals)</td>
        <td class="num">${formatSignedCurrency(gap)}</td>
      </tr>
    `);
  }

  table.insertAdjacentHTML("beforeend", `
    <tr class="total-row">
      <td>Total</td>
      <td class="num">₹${formatCurrency(o.total)}</td>
    </tr>
  `);

  document.getElementById("receipt").style.display = "block";
}

function fail(msg) {
  document.getElementById("error").innerText = msg;
}

function formatCurrency(val) {
  const n = Number(val);
  if (Number.isFinite(n)) return n.toFixed(2);
  return String(val ?? 0);
}

function parseAmount(text) {
  const m = text.match(/₹\s*(-?\d+(?:\.\d+)?)/);
  return m ? Number(m[1]) : 0;
}

function normalizeLines(val) {
  if (Array.isArray(val)) return val.map(v => String(v));
  if (typeof val === "string") return val.split(/\r?\n/);
  return [];
}

function formatSignedCurrency(val, label) {
  const n = Number(val);
  if (!Number.isFinite(n)) return String(val ?? 0);

  let num = n;
  const text = (label || "").toLowerCase();
  if (num > 0 && (text.includes("discount") || text.includes("coupon"))) {
    num = -num;
  }

  const sign = num >= 0 ? "+" : "-";
  return `${sign}₹${Math.abs(num).toFixed(2)}`;
}
</script>

</body>
</html>
